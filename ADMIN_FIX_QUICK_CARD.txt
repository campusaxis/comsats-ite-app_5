╔══════════════════════════════════════════════════════════════════════════════╗
║                    🚨 ADMIN ACCESS FIX - QUICK CARD                          ║
╚══════════════════════════════════════════════════════════════════════════════╝

PROBLEM: "Failed to promote user to admin" error
CAUSE:   Row Level Security (RLS) policies blocking admin management
FIX:     Update RLS policies to allow super_admins to manage other admins

╔══════════════════════════════════════════════════════════════════════════════╗
║                         ⚡ 2-MINUTE FIX (COPY & PASTE)                       ║
╚══════════════════════════════════════════════════════════════════════════════╝

STEP 1: Open Supabase Dashboard
        https://supabase.com/dashboard/project/YOUR_PROJECT_ID

STEP 2: Click "SQL Editor" → "New query"

STEP 3: Copy and paste this SQL:

-- ============================================================================
-- Drop old restrictive policies
DROP POLICY IF EXISTS "admin_users_self_read" ON public.admin_users;
DROP POLICY IF EXISTS "read own admin row" ON public.admin_users;

-- Allow everyone to read admin_users (safe - just role info)
CREATE POLICY "authenticated_read_admin_users" 
ON public.admin_users 
FOR SELECT 
TO authenticated 
USING (true);

-- Allow super_admins to manage admin_users
CREATE POLICY "super_admin_manage_admin_users" 
ON public.admin_users 
FOR ALL
TO authenticated 
USING (
  EXISTS (
    SELECT 1 FROM admin_users 
    WHERE user_id = auth.uid() 
    AND role = 'super_admin'
  )
);

-- Add yourself as super_admin
-- ⚠️ CHANGE EMAIL IN NEXT 2 LINES!
INSERT INTO public.admin_users (user_id, role, permissions)
SELECT id, 'super_admin', ARRAY['all']
FROM auth.users
WHERE email = 'YOUR_EMAIL@cuilahore.edu.pk'  -- ⚠️ CHANGE THIS!
ON CONFLICT (user_id) 
DO UPDATE SET 
  role = 'super_admin',
  permissions = ARRAY['all'];

-- Verify it worked
SELECT 
  au.role,
  au.permissions,
  u.email,
  au.created_at
FROM admin_users au
JOIN auth.users u ON u.id = au.user_id
WHERE u.email = 'YOUR_EMAIL@cuilahore.edu.pk';  -- ⚠️ CHANGE THIS!
-- ============================================================================

STEP 4: Replace YOUR_EMAIL@cuilahore.edu.pk with YOUR actual email (2 places!)

STEP 5: Click "RUN" button

STEP 6: Check output shows your email with role = 'super_admin'

STEP 7: Go back to your app and refresh (Ctrl + Shift + R)

STEP 8: Try promoting a user again → Should work! ✅

╔══════════════════════════════════════════════════════════════════════════════╗
║                           📋 VERIFICATION CHECKLIST                          ║
╚══════════════════════════════════════════════════════════════════════════════╝

After running the SQL above:

□ SQL query executed without errors
□ Verification query shows your email with 'super_admin' role  
□ Can see list of all users in admin panel
□ Can click "Promote" button on a user
□ Can select role (admin/super_admin) in dialog
□ Can select permissions in dialog
□ "Promote to Admin" button works without error
□ New admin appears in the list
□ No "Failed to promote user" error

If ANY checkbox is unchecked, see troubleshooting below.

╔══════════════════════════════════════════════════════════════════════════════╗
║                            🔧 TROUBLESHOOTING                                ║
╚══════════════════════════════════════════════════════════════════════════════╝

ERROR: "permission denied for table admin_users"
FIX:   You're using anon key instead of service role key
       Check: .env.local has SUPABASE_SERVICE_ROLE_KEY set

ERROR: "Failed to promote user to admin" (still!)
FIX:   Clear browser cache and cookies, then login again
       Or try incognito mode

ERROR: "User is already an admin"
FIX:   User already exists in admin_users table
       Check: SELECT * FROM admin_users WHERE user_id = 'USER_ID';

ERROR: SQL query fails
FIX:   Run diagnostic queries: scripts/diagnose-admin.sql
       Look for specific error in Supabase logs

ISSUE: Can promote but user doesn't appear
FIX:   Hard refresh the page: Ctrl + Shift + R
       Or check database: SELECT * FROM admin_users;

ISSUE: Not seeing any users to promote
FIX:   Check auth.users table has users
       Run: SELECT COUNT(*) FROM auth.users;

╔══════════════════════════════════════════════════════════════════════════════╗
║                              📚 FULL DOCUMENTATION                           ║
╚══════════════════════════════════════════════════════════════════════════════╝

Quick Guide:     ADMIN_FIX_GUIDE.md
Full Summary:    ADMIN_FIX_COMPLETE.md  
SQL Scripts:     scripts/fix-admin-access.sql
Diagnostics:     scripts/diagnose-admin.sql
Auto Script:     scripts/fix-admin-cli.ps1
Migration:       supabase/migrations/20251009000000_fix_admin_users_rls.sql

╔══════════════════════════════════════════════════════════════════════════════╗
║                               🎯 WHAT YOU GET                                ║
╚══════════════════════════════════════════════════════════════════════════════╝

BEFORE FIX:
  ❌ Can't see all admin users
  ❌ "Failed to promote user to admin" error
  ❌ Can't manage admin roles
  ❌ Admin panel limited

AFTER FIX:
  ✅ See complete list of all admin users
  ✅ Promote any user to admin/super_admin
  ✅ Update admin roles and permissions
  ✅ Remove admin access when needed
  ✅ Full admin panel functionality
  ✅ Proper security with RLS enabled

╔══════════════════════════════════════════════════════════════════════════════╗
║                           ⏱️ TIME & DIFFICULTY                               ║
╚══════════════════════════════════════════════════════════════════════════════╝

Method:          Option 1 (SQL Dashboard)
Time:            2 minutes
Difficulty:      ⭐ Easy
Success Rate:    99%
Requirements:    Supabase dashboard access

Alternative Methods:
  - CLI Script:  .\scripts\fix-admin-cli.ps1  (3 min, medium)
  - Manual:      See ADMIN_FIX_GUIDE.md       (5 min, advanced)

╔══════════════════════════════════════════════════════════════════════════════╗
║                              🚀 READY TO START?                              ║
╚══════════════════════════════════════════════════════════════════════════════╝

1. Open: https://supabase.com/dashboard
2. Copy: SQL from STEP 3 above
3. Paste: Into SQL Editor
4. Edit: Change YOUR_EMAIL@cuilahore.edu.pk (2 places)
5. Run: Click the RUN button
6. Verify: Check output shows your admin role
7. Test: Refresh app and try promoting a user

Need help? Read ADMIN_FIX_GUIDE.md for detailed walkthrough.

═══════════════════════════════════════════════════════════════════════════════
