```
╔══════════════════════════════════════════════════════════════════════╗
║                                                                      ║
║       🚨 FIX: Infinite Recursion Error (Code: 42P17) 🚨             ║
║                                                                      ║
╚══════════════════════════════════════════════════════════════════════╝

ERROR MESSAGE:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  Error (500)
  infinite recursion detected in policy for relation 'admin_users' 
  (Code: 42P17)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

CAUSE:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  RLS policy checks admin_users table...
  ...while trying to access admin_users table
  = INFINITE LOOP! 🔄∞
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    ⚡ QUICK FIX (2 MINUTES) ⚡
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

STEP 1: Open Supabase Dashboard
┌──────────────────────────────────────────────────────────────────┐
│  https://supabase.com/dashboard                                  │
│  → Select your project                                           │
│  → Click "SQL Editor" (left sidebar)                             │
└──────────────────────────────────────────────────────────────────┘

STEP 2: Copy This SQL (Ctrl+C)
┌──────────────────────────────────────────────────────────────────┐
│ BEGIN;                                                           │
│                                                                  │
│ -- Drop problematic policies                                    │
│ DROP POLICY IF EXISTS "authenticated_read_admin_users"          │
│   ON "public"."admin_users";                                    │
│ DROP POLICY IF EXISTS "super_admin_insert_admin_users"          │
│   ON "public"."admin_users";                                    │
│ DROP POLICY IF EXISTS "super_admin_update_admin_users"          │
│   ON "public"."admin_users";                                    │
│ DROP POLICY IF EXISTS "super_admin_delete_admin_users"          │
│   ON "public"."admin_users";                                    │
│ DROP POLICY IF EXISTS "admin_users_self_read"                   │
│   ON "public"."admin_users";                                    │
│ DROP POLICY IF EXISTS "read own admin row"                      │
│   ON "public"."admin_users";                                    │
│                                                                  │
│ -- Enable RLS                                                   │
│ ALTER TABLE "public"."admin_users"                              │
│   ENABLE ROW LEVEL SECURITY;                                    │
│                                                                  │
│ -- Create non-recursive policies                               │
│ CREATE POLICY "admin_users_read_own"                            │
│ ON "public"."admin_users"                                       │
│ FOR SELECT TO authenticated                                     │
│ USING (user_id = auth.uid());                                   │
│                                                                  │
│ CREATE POLICY "admin_users_read_all"                            │
│ ON "public"."admin_users"                                       │
│ FOR SELECT TO authenticated                                     │
│ USING (true);                                                   │
│                                                                  │
│ COMMIT;                                                          │
└──────────────────────────────────────────────────────────────────┘

STEP 3: Paste in SQL Editor (Ctrl+V)

STEP 4: Click "Run" (or press Ctrl+Enter)

STEP 5: Wait for ✅ Success message

STEP 6: Go back to /admin/auth and try again!

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                        ✅ THAT'S IT! DONE!
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

WHAT THIS DOES:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ✓ Removes broken policies that cause recursion
  ✓ Creates simple, safe policies that don't recurse
  ✓ Allows authenticated users to read admin_users
  ✓ Prevents infinite loops
  ✓ Fixes the 42P17 error completely
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

WHY IT'S SAFE:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  • admin_users table only has role info (not sensitive data)
  • Users need to read this to check if they're admin
  • Actual admin operations use service role key
  • Service role bypasses RLS anyway
  • No security risk!
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

AFTER APPLYING:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  1. Refresh /admin/auth page (Ctrl+Shift+R)
  2. Click "Continue as Admin"
  3. Should work! ✓
  
  If not admin yet:
  4. Go to /admin/diagnostic
  5. Click "Auto-Fix (Dev Only)"
  6. Now you're admin! ✓
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

TROUBLESHOOTING:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ❌ Still see error?
     → Hard refresh: Ctrl+Shift+R
     → Clear cache in DevTools
     → Sign out and back in
     
  ❌ SQL fails?
     → Check for typos
     → Make sure you copied full SQL
     → Try running each DROP POLICY separately
     
  ❌ Need help?
     → See: FIX_INFINITE_RECURSION_NOW.md
     → Full documentation with explanations
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

╔══════════════════════════════════════════════════════════════════════╗
║                                                                      ║
║                    🎉 PROBLEM SOLVED! 🎉                            ║
║                                                                      ║
║              Admin access will work after this fix!                  ║
║                                                                      ║
╚══════════════════════════════════════════════════════════════════════╝
```
